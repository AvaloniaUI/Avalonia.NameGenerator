using System.Collections.Generic;
using Avalonia.NameGenerator.Domain;
using XamlX.TypeSystem;

namespace Avalonia.NameGenerator.Generator
{
    internal class InitializeComponentCodeGenerator: ICodeGenerator
    {
        private readonly bool _diagnosticsAreConnected;
        private const string AttachDevToolsCodeBlock = @"
#if DEBUG
            if (attachDevTools)
            {
                this.AttachDevTools();
            }          
#endif
";

        public InitializeComponentCodeGenerator(IXamlTypeSystem types)
        {
            _diagnosticsAreConnected = types.FindAssembly("Avalonia.Diagnostics") != null;
        }

        public string GenerateCode(string className, string nameSpace, IXamlType XamlType, IEnumerable<ResolvedName> names)
        {
            var properties = new List<string>();
            var initializations = new List<string>();
            foreach (var (typeName, name, fieldModifier) in names)
            {
                properties.Add($"        {fieldModifier} global::{typeName} {name};");
                initializations.Add($"            {name} = this.FindControl<global::{typeName}>(\"{name}\");");
            }

            var attachDevTools = _diagnosticsAreConnected && IsWindow(XamlType);

            return $@"// <auto-generated />

using Avalonia.Controls;
using Avalonia.Markup.Xaml;

namespace {nameSpace}
{{
    partial class {className}
    {{
{string.Join("\n", properties)}

        public void InitializeComponent(bool loadXaml = true{(attachDevTools ? ", bool attachDevTools = true" : string.Empty)})
        {{
            if (loadXaml)
            {{
                AvaloniaXamlLoader.Load(this);
            }}
{(attachDevTools ? AttachDevToolsCodeBlock : string.Empty)}
{string.Join("\n", initializations)}
        }}
    }}
}}
";
        }
        
        private bool IsWindow(IXamlType XamlType)
        {
            var type = XamlType;
            bool isWindow;
            do
            {
                isWindow = type.FullName == "Avalonia.Controls.Window";
                type = type.BaseType;
            } while (!isWindow && type != null);

            return isWindow;
        }
    }
}